name: Deploy to EC2

on:
  push:
    branches:
      - develop

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ JDK ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Create application.properties
        run: |
          cat <<EOF > DriveMate/spring/src/main/resources/application.properties
          spring.datasource.url=${{ secrets.RDS_URL }}
          spring.datasource.username=${{ secrets.RDS_USERNAME }}
          spring.datasource.password=${{ secrets.RDS_PASSWORD }}
          spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

          spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
          spring.jpa.hibernate.ddl-auto=update
          EOF

      # 3ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Grant execute permission for gradlew  # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x DriveMate/spring/gradlew

      - name: Build with Gradle  # Gradleì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë¹Œë“œ
        uses: gradle/gradle-build-action@v2
        with:
          arguments: build
          build-root-directory: DriveMate/spring

      # 4ï¸âƒ£ ë¹Œë“œëœ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Drivemate-Server
          path: DriveMate/spring/build/libs/*.jar
          
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: DriveMate/spring/build/reports/tests/test/

  # 5ï¸âƒ£ ë°°í¬
  deploy:
      needs: build  # build ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ ì‹¤í–‰
      runs-on: ubuntu-latest
  
      steps:
        - name: Download build artifact  # ì´ì „ ë‹¨ê³„ì—ì„œ ì—…ë¡œë“œí•œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
          uses: actions/download-artifact@v4
          with:
            name: Drivemate-Server
            path: build/libs/
  
        - name: Deploy to EC2  # EC2ì— ë°°í¬
          env:
            EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
            EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
            EC2_HOST: ${{ secrets.EC2_HOST }}
          run: |
            echo "$EC2_SSH_KEY" > drivemate.pem
            chmod 600 drivemate.pem
            
            # JAR íŒŒì¼ ì°¾ê¸°
            jar_file=$(find build/libs -name '*.jar' ! -name '*plain.jar' | head -n 1)
            echo "JAR íŒŒì¼ ê²½ë¡œ: $jar_file"
  
            # EC2ì— JAR íŒŒì¼ ì „ì†¡
            scp -i drivemate.pem -o StrictHostKeyChecking=no "$jar_file" $EC2_USERNAME@$EC2_HOST:/home/$EC2_USERNAME/Drivemate-Server.jar
            
            # EC2ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì„œë²„ ì¢…ë£Œ ë° ìƒˆ JAR ì‹¤í–‰
            ssh -i drivemate.pem -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_HOST << 'EOF'
              echo "ğŸ”„ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
              pkill -f 'java -jar' || echo "No process to kill"
  
              echo "ğŸš€ ìƒˆë¡œìš´ ì„œë²„ ì‹¤í–‰ ì¤‘..."
              nohup java -jar /home/$EC2_USERNAME/Drivemate-Server.jar > /home/$EC2_USERNAME/app.log 2>&1 &
              echo "âœ… ë°°í¬ ì™„ë£Œ"
            EOF
  
            # SSH í‚¤ ì‚­ì œ
            rm -f drivemate.pem 
